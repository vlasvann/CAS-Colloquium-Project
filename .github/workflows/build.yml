name: Build Qt Application

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libgl1-mesa-dev \
          qt6-base-dev \
          qmake6
          
    - name: Build application
      run: |
        mkdir -p build
        cd build
        qmake6 ../ComputerAlgebraSystem.pro
        make -j4
        
    - name: Create Simple Portable Package
      run: |
        mkdir -p ComputerAlgebraSystem

        cp build/ComputerAlgebraSystem ComputerAlgebraSystem/
        
        cat > ComputerAlgebraSystem/Run.sh << 'EOF'
        #!/bin/bash
        cd "$(dirname "$0")"
        ./ComputerAlgebraSystem
        EOF
        chmod +x ComputerAlgebraSystem/Run.sh
        
        cat > ComputerAlgebraSystem/ComputerAlgebraSystem.desktop << EOF
        [Desktop Entry]
        Version=1.0
        Type=Application
        Name=Computer Algebra System
        Comment=Computer Algebra System
        Exec=$PWD/ComputerAlgebraSystem/Run.sh
        Icon=
        Categories=Education;
        Terminal=false
        StartupNotify=false
        EOF

        tar -czf ComputerAlgebraSystem-Linux.tar.gz ComputerAlgebraSystem/
        
        cat > INSTRUCTIONS.txt << 'EOF'
        КАК ЗАПУСТИТЬ:
        
        1. Распакуйте архив:
           tar -xzf ComputerAlgebraSystem-Linux.tar.gz
           
        2. Перейдите в папку:
           cd ComputerAlgebraSystem
           
        3. Запустите:
           ./Run.sh
           
        ИЛИ просто дважды кликните на файл Run.sh
        EOF
        
    - name: Upload Portable Package
      uses: actions/upload-artifact@v4
      with:
        name: ComputerAlgebraSystem-Portable
        path: |
          ComputerAlgebraSystem-Linux.tar.gz
          INSTRUCTIONS.txt
        retention-days: 30
