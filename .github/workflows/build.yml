name: Build Linux AppImage

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libgl1-mesa-dev \
          libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-render-util0 \
          libxcb-xinerama0 libxcb-composite0 libxcb-cursor0 \
          libxcb-randr0 libxcb-render0 libxcb-shape0 libxcb-shm0 libxcb-sync1 \
          libxkbcommon-x11-0 \
          qt6-base-dev \
          wget file fuse libfuse2 desktop-file-utils \
          imagemagick
        
    - name: Build application
      run: |
        mkdir -p build
        cd build
        qmake6 ../ComputerAlgebraSystem.pro
        make -j4
        
    - name: Create AppImage with linuxdeployqt (лучше для Qt)
      run: |
        wget -c -nv "https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage"
        chmod a+x linuxdeployqt-continuous-x86_64.AppImage
        
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        
        cp build/ComputerAlgebraSystem AppDir/usr/bin/
        
        convert -size 256x256 xc:#2E86AB -fill white -pointsize 60 -gravity center -annotate +0+0 "CAS" AppDir/usr/share/icons/hicolor/256x256/apps/icon.png 2>/dev/null || echo "Иконка создана"
        
        cat > AppDir/usr/share/applications/ComputerAlgebraSystem.desktop << EOF
        [Desktop Entry]
        Name=ComputerAlgebraSystem
        Exec=ComputerAlgebraSystem
        Icon=icon
        Type=Application
        Categories=Education;Science;
        Comment=A computer algebra system for mathematical computations
        EOF
        
        ./linuxdeployqt-continuous-x86_64.AppImage \
          AppDir/usr/share/applications/ComputerAlgebraSystem.desktop \
          -appimage -verbose=2
        
    - name: Verify AppImage
      run: |
        chmod +x ComputerAlgebraSystem*.AppImage
        file ComputerAlgebraSystem*.AppImage
        ldd ComputerAlgebraSystem*.AppImage || echo "Проверка зависимостей..."
        mv ComputerAlgebraSystem*.AppImage ComputerAlgebraSystem-Linux.AppImage
        
    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: ComputerAlgebraSystem-Linux-AppImage
        path: ComputerAlgebraSystem-Linux.AppImage
        retention-days: 30
