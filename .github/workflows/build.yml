name: Build Qt Application

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libgl1-mesa-dev \
          qt6-base-dev \
          qmake6 \
          wget \
          file \
          imagemagick
          
    - name: Build application
      run: |
        mkdir -p build
        cd build
        qmake6 ../ComputerAlgebraSystem.pro
        make -j4
        
    - name: Create Universal AppImage
      run: |
        wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage
        
        mkdir -p assets
        convert -size 256x256 xc:#2E86AB assets/icon.png
        
        cat > ComputerAlgebraSystem.desktop << EOF
        [Desktop Entry]
        Name=ComputerAlgebraSystem
        Exec=ComputerAlgebraSystem
        Icon=icon
        Type=Application
        Categories=Education;Science;
        Comment=A computer algebra system for mathematical computations
        EOF
        
        ./linuxdeploy-x86_64.AppImage --appdir AppDir -e build/ComputerAlgebraSystem -d ComputerAlgebraSystem.desktop -i assets/icon.png --output appimage
        
        mv ComputerAlgebraSystem-x86_64.AppImage ComputerAlgebraSystem-Linux.AppImage
        
        cat > ComputerAlgebraSystem << 'EOF'
        #!/bin/bash
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        
        if [ -f "$SCRIPT_DIR/ComputerAlgebraSystem-Linux.AppImage" ]; then
            if "$SCRIPT_DIR/ComputerAlgebraSystem-Linux.AppImage" --appimage-help >/dev/null 2>&1; then
                exec "$SCRIPT_DIR/ComputerAlgebraSystem-Linux.AppImage" "$@"
            else
                echo "Extracting AppImage for better compatibility..."
                "$SCRIPT_DIR/ComputerAlgebraSystem-Linux.AppImage" --appimage-extract
                exec "$SCRIPT_DIR/squashfs-root/AppRun" "$@"
            fi
        else
            echo "Error: ComputerAlgebraSystem-Linux.AppImage not found!"
            exit 1
        fi
        EOF
        
        chmod +x ComputerAlgebraSystem
        
    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: ComputerAlgebraSystem-AppImage
        path: |
          ComputerAlgebraSystem-Linux.AppImage
          ComputerAlgebraSystem  # ← Исполняемый файл без расширения
        retention-days: 30
