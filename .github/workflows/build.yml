name: Build Qt Application

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libgl1-mesa-dev \
          qt6-base-dev \
          qmake6 \
          wget \
          file
          
    - name: Build application
      run: |
        mkdir -p build
        cd build
        qmake6 ../ComputerAlgebraSystem.pro
        make -j4
        
    - name: Create Universal AppImage
      run: |
        wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage
        
        mkdir -p assets
        echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" | base64 -d > assets/icon.png
        
        cat > ComputerAlgebraSystem.desktop << EOF
        [Desktop Entry]
        Name=ComputerAlgebraSystem
        Exec=ComputerAlgebraSystem
        Icon=icon
        Type=Application
        Categories=Education;Science;
        Comment=A computer algebra system for mathematical computations
        EOF
        
        ./linuxdeploy-x86_64.AppImage --appdir AppDir -e build/ComputerAlgebraSystem -d ComputerAlgebraSystem.desktop -i assets/icon.png --output appimage
        
        mv ComputerAlgebraSystem-x86_64.AppImage ComputerAlgebraSystem-Linux.AppImage
        
        cat > Launch-For-All-Ubuntu.sh << 'EOF'
        #!/bin/bash
        if ./ComputerAlgebraSystem-Linux.AppImage --appimage-help >/dev/null 2>&1; then
            ./ComputerAlgebraSystem-Linux.AppImage "$@"
        else
            echo "Extracting AppImage for Ubuntu 24.04 compatibility..."
            ./ComputerAlgebraSystem-Linux.AppImage --appimage-extract
            ./squashfs-root/AppRun "$@"
        fi
        EOF
        chmod +x Launch-For-All-Ubuntu.sh
        
    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: ComputerAlgebraSystem-AppImage
        path: |
          ComputerAlgebraSystem-Linux.AppImage
          Launch-For-All-Ubuntu.sh
        retention-days: 30
