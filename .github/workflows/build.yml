name: Build for All Linux

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libgl1-mesa-dev \
          qt6-base-dev \
          qmake6 \
          wget \
          file
          
    - name: Build application
      run: |
        mkdir -p build
        cd build
        qmake6 ../ComputerAlgebraSystem.pro
        make -j4
        
    - name: Create UNIVERSAL LINUX PACKAGE
      run: |
        mkdir -p ComputerAlgebraSystem
        
        cp build/ComputerAlgebraSystem ComputerAlgebraSystem/
        
        cat > ComputerAlgebraSystem/ComputerAlgebraSystem << 'EOF'
        #!/bin/bash

        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        cd "$SCRIPT_DIR"
        
        fix_libraries() {
            echo "Setting up library path..."
            export LD_LIBRARY_PATH="$SCRIPT_DIR:${LD_LIBRARY_PATH}"
        }
        
        fix_libraries
        
        exec "./ComputerAlgebraSystem.bin" "$@"
        EOF
        
        mv ComputerAlgebraSystem/ComputerAlgebraSystem ComputerAlgebraSystem/ComputerAlgebraSystem.bin
        
        chmod +x ComputerAlgebraSystem/ComputerAlgebraSystem
        chmod +x ComputerAlgebraSystem/ComputerAlgebraSystem.bin
        
        cat > ComputerAlgebraSystem/install-libs.sh << 'EOF'
        #!/bin/bash
        echo "Copying required libraries..."
        
        LIBRARIES=(
            "/usr/lib/x86_64-linux-gnu/libQt6Core.so.6"
            "/usr/lib/x86_64-linux-gnu/libQt6Gui.so.6" 
            "/usr/lib/x86_64-linux-gnu/libQt6Widgets.so.6"
        )
        
        for lib in "${LIBRARIES[@]}"; do
            if [ -f "$lib" ]; then
                cp "$lib" .
                echo "Copied: $(basename "$lib")"
            fi
        done
        
        echo "Done! Now try: ./ComputerAlgebraSystem"
        EOF
        chmod +x ComputerAlgebraSystem/install-libs.sh
        
        cat > ComputerAlgebraSystem/README.txt << 'EOF'
        ðŸš€ COMPUTER ALGEBRA SYSTEM - LINUX
        
        === ÐšÐÐš Ð—ÐÐŸÐ£Ð¡Ð¢Ð˜Ð¢Ð¬ ===
        
        1. ÐŸÐ ÐžÐ¡Ð¢ÐžÐ™ Ð¡ÐŸÐžÐ¡ÐžÐ‘ (Ð´Ð²Ð¾Ð¹Ð½Ð¾Ð¹ ÐºÐ»Ð¸Ðº):
           - Ð”Ð²Ð°Ð¶Ð´Ñ‹ ÐºÐ»Ð¸ÐºÐ½Ð¸Ñ‚Ðµ Ð½Ð° Ñ„Ð°Ð¹Ð» "ComputerAlgebraSystem"
           - Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ "Run" Ð¸Ð»Ð¸ "Execute"
        
        2. Ð¢Ð•Ð ÐœÐ˜ÐÐÐ›:
           ./ComputerAlgebraSystem
        
        3. Ð•Ð¡Ð›Ð˜ ÐÐ• Ð—ÐÐŸÐ£Ð¡ÐšÐÐ•Ð¢Ð¡Ð¯:
           ./install-libs.sh
           ./ComputerAlgebraSystem
        
        === Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐÐ«Ð• Ð¢Ð Ð•Ð‘ÐžÐ’ÐÐÐ˜Ð¯ ===
        - Ubuntu 22.04, 23.04, 24.04+
        - Fedora 36+
        - Arch Linux
        - Linux Mint 21+
        - Debian 11+
        - Ð˜ Ð›Ð®Ð‘ÐžÐ™ Ð”Ð Ð£Ð“ÐžÐ™ Linux!
        
        EOF
        
        tar -czf ComputerAlgebraSystem-Linux.tar.gz ComputerAlgebraSystem/
        
    - name: Create SIMPLE LAUNCH SCRIPT
      run: |
        cat > Run-ComputerAlgebraSystem.sh << 'EOF'
        #!/bin/bash
        echo "ðŸš€ Starting Computer Algebra System..."
        echo "If this doesn't work, extract the tar.gz archive"
        
        if [ -f "ComputerAlgebraSystem-Linux.tar.gz" ]; then
            tar -xzf ComputerAlgebraSystem-Linux.tar.gz
            cd ComputerAlgebraSystem
            ./ComputerAlgebraSystem
        else
            echo "Error: ComputerAlgebraSystem-Linux.tar.gz not found!"
        fi
        EOF
        chmod +x Run-ComputerAlgebraSystem.sh
        
    - name: Upload FINAL PACKAGE
      uses: actions/upload-artifact@v4
      with:
        name: ComputerAlgebraSystem-Linux
        path: |
          ComputerAlgebraSystem-Linux.tar.gz
          Run-ComputerAlgebraSystem.sh
        retention-days: 30
