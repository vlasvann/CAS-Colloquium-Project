name: Build Qt App (AppImage, Linux Universal)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    name: Build ComputerAlgebraSystem AppImage
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.2'
          modules: 'qtbase qttools'
          setup-python: false

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libgl1-mesa-dev patchelf

      - name: Build Qt project
        run: |
          qmake ComputerAlgebraSystem.pro CONFIG+=release
          make -j$(nproc)
          mkdir -p AppDir/usr/bin
          cp build/ComputerAlgebraSystem AppDir/usr/bin/

      - name: Create desktop entry (no icon)
        run: |
          mkdir -p AppDir/usr/share/applications
          echo "[Desktop Entry]
          Type=Application
          Name=Computer Algebra System
          Exec=ComputerAlgebraSystem
          Categories=Education;Science;Math;" > AppDir/usr/share/applications/ComputerAlgebraSystem.desktop

      - name: Download AppImageTool
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Create AppImage
        run: |
          ./appimagetool-x86_64.AppImage AppDir ComputerAlgebraSystem-x86_64.AppImage

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: ComputerAlgebraSystem-AppImage
          path: ComputerAlgebraSystem-x86_64.AppImage
