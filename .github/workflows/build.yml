name: Build Linux AppImage

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          qt6-base-dev \
          qt6-charts-dev \
          libgl1-mesa-dev \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-render-util0 \
          libxcb-xinerama0 \
          libxcb-composite0 \
          wget \
          file \
          fuse \
          libfuse2 \
          desktop-file-utils

    - name: Build application with qmake
      run: |
        mkdir -p build
        qmake6 CONFIG+=release -o build/Makefile
        cd build
        make -j$(nproc)

    - name: Create AppDir
      run: |
        mkdir -p appdir/usr/bin/
        cp build/ComputerAlgebraSystem appdir/usr/bin/
        
        cat > ComputerAlgebraSystem.desktop << EOF
            [Desktop Entry]
            Name=ComputerAlgebraSystem
            Exec=ComputerAlgebraSystem
            Icon=icon
            Type=Application
            Categories=Education;Science;
            Comment=A computer algebra system for mathematical computations
            EOF
        
        mkdir -p appdir/usr/share/applications/
        cp ComputerAlgebraSystem.desktop appdir/usr/share/applications/

    - name: Download linuxdeployqt
      run: |
        wget -c -nv "https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage"
        chmod a+x linuxdeployqt-continuous-x86_64.AppImage

    - name: Create AppImage
      run: |
        ./linuxdeployqt-continuous-x86_64.AppImage \
          appdir/usr/share/applications/ComputerAlgebraSystem.desktop \
          -appimage -verbose=2

    - name: Verify AppImage
      run: |
        chmod +x ComputerAlgebraSystem*.AppImage
        file ComputerAlgebraSystem*.AppImage
        echo "✅ AppImage создан успешно"
        mv ComputerAlgebraSystem*.AppImage ComputerAlgebraSystem-Linux.AppImage
        
    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: ComputerAlgebraSystem-Linux-AppImage
        path: ComputerAlgebraSystem-Linux.AppImage
        retention-days: 30
