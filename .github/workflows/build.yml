name: Build Linux AppImage

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libgl1-mesa-dev qt6-base-dev wget file
        
    - name: Build application
      run: |
        mkdir build
        cd build
        qmake6 ../ComputerAlgebraSystem.pro
        make -j4
        
    - name: Create AppImage
      run: |
        wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage
        
        mkdir -p assets
        echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" | base64 -d > assets/icon.png
        
        ./linuxdeploy-x86_64.AppImage --appdir AppDir -e build/ComputerAlgebraSystem -d ComputerAlgebraSystem.desktop -i assets/icon.png --output appimage
        
        mv ComputerAlgebraSystem*.AppImage ComputerAlgebraSystem-Linux.AppImage
        
    - name: Verify AppImage
      run: |
        chmod +x ComputerAlgebraSystem-Linux.AppImage
        file ComputerAlgebraSystem-Linux.AppImage
        echo "âœ… AppImage created successfully"
        
    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: ComputerAlgebraSystem-Linux-AppImage
        path: ComputerAlgebraSystem-Linux.AppImage
        retention-days: 30
