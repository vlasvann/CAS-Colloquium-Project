name: Build Universal AppImage

on: [push]

jobs:
  build:
    runs-on: ubuntu-20.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Qt
      run: |
        sudo apt update && sudo apt install -y \
          build-essential \
          libgl1-mesa-dev \
          qt6-base-dev \
          qmake6
        
    - name: Build
      run: |
        mkdir build && cd build
        qmake6 .. 
        make -j$(nproc)
    
    - name: Create AppImage
      run: |
        wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy*.AppImage
        
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" | base64 -d > AppDir/usr/share/icons/hicolor/256x256/apps/icon.png
        
        mkdir -p AppDir/usr/share/applications
        cat > AppDir/usr/share/applications/ComputerAlgebraSystem.desktop << 'EOF'
        [Desktop Entry]
        Name=Computer Algebra System
        Exec=ComputerAlgebraSystem
        Icon=icon
        Type=Application
        Categories=Education;Science;
        Comment=Computer Algebra System
        EOF
        
        mkdir -p AppDir/usr/bin
        cp build/ComputerAlgebraSystem AppDir/usr/bin/
        
        wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool*.AppImage
        
        ./appimagetool-x86_64.AppImage \
          --comp xz \
          AppDir \
          ComputerAlgebraSystem-Linux.AppImage
        
    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: ComputerAlgebraSystem
        path: ComputerAlgebraSystem-Linux.AppImage
