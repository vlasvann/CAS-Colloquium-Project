name: üîß Build Windows Application
on:
  pull_request:
  push:
    branches: [BabinTest, main]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Install Qt with MinGW
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.9.3'
          host: windows
          target: desktop
          arch: win64_mingw
          cache: true

      - name: Build with MinGW
        run: |
          echo "üèóÔ∏è Building with MinGW..."
          
          # –î–æ–±–∞–≤–ª—è–µ–º MinGW –≤ PATH
          $env:PATH = "C:\Qt\6.9.3\mingw_64\bin;" + $env:PATH
          
          echo "üîß Checking tools..."
          qmake.exe -version
          g++.exe --version
          mingw32-make.exe --version
          
          echo "üî® Running qmake..."
          qmake.exe ComputerAlgebraSystem.pro
          
          echo "üî® Running make..."
          mingw32-make.exe
          
          echo "‚úÖ Build completed"

      - name: Verify binary exists
        run: |
          echo "üîç Looking for binary..."
          if (Test-Path "release\ComputerAlgebraSystem.exe") {
            echo "‚úÖ Binary found in release folder"
            copy release\ComputerAlgebraSystem.exe .\
          } elseif (Test-Path "ComputerAlgebraSystem.exe") {
            echo "‚úÖ Binary found in root folder"
          } else {
            echo "‚ùå Binary not found"
            echo "üìÅ Searching for executable files..."
            Get-ChildItem -Recurse -Include *.exe | ForEach-Object { echo "Found: $($_.FullName)" }
            exit 1
          }
          
          echo "üìä Binary info:"
          dir ComputerAlgebraSystem.exe

      - name: Deploy dependencies with windeployqt
        run: |
          echo "üì¶ Deploying dependencies..."
          windeployqt.exe --release ComputerAlgebraSystem.exe
          echo "‚úÖ Dependencies deployed"

      - name: Create portable package
        run: |
          echo "üì¶ Creating portable package..."
          
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –ø–æ—Ä—Ç–∞—Ç–∏–≤–Ω–æ–π –≤–µ—Ä—Å–∏–∏
          mkdir ComputerAlgebraSystem_Portable
          
          # –ö–æ–ø–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –±–∏–Ω–∞—Ä–Ω–∏–∫
          copy ComputerAlgebraSystem.exe ComputerAlgebraSystem_Portable\
          
          # –ö–æ–ø–∏—Ä—É–µ–º DLL –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          copy *.dll ComputerAlgebraSystem_Portable\ 2>$null || echo "No DLLs to copy"
          
          # –ö–æ–ø–∏—Ä—É–µ–º –ø–∞–ø–∫–∏ —Å –ø–ª–∞–≥–∏–Ω–∞–º–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
          if (Test-Path "platforms") { 
            copy platforms ComputerAlgebraSystem_Portable\ -Recurse 
            echo "‚úÖ Copied platforms folder"
          }
          if (Test-Path "imageformats") { 
            copy imageformats ComputerAlgebraSystem_Portable\ -Recurse 
            echo "‚úÖ Copied imageformats folder"
          }
          if (Test-Path "styles") { 
            copy styles ComputerAlgebraSystem_Portable\ -Recurse 
            echo "‚úÖ Copied styles folder"
          }
          
          # –°–æ–∑–¥–∞–µ–º ZIP –∞—Ä—Ö–∏–≤
          Compress-Archive -Path ComputerAlgebraSystem_Portable\* -DestinationPath ComputerAlgebraSystem-Windows-Portable.zip -Force
          
          echo "‚úÖ Portable package created: ComputerAlgebraSystem-Windows-Portable.zip"
          dir ComputerAlgebraSystem-Windows-Portable.zip

      - name: Upload portable package
        uses: actions/upload-artifact@v4
        with:
          name: ComputerAlgebraSystem-Windows-Portable.zip
          path: ComputerAlgebraSystem-Windows-Portable.zip
          retention-days: 30

      - name: Upload standalone executable
        uses: actions/upload-artifact@v4
        with:
          name: ComputerAlgebraSystem-Windows.exe
          path: ComputerAlgebraSystem.exe
          retention-days: 30

      - name: Show build summary
        run: |
          echo ""
          echo "üéä BUILD SUCCESSFUL! üéä"
          echo "üì¶ Artifacts uploaded:"
          echo "   - ComputerAlgebraSystem-Windows-Portable.zip (complete portable package)"
          echo "   - ComputerAlgebraSystem-Windows.exe (standalone executable)"
          echo ""
          echo "üöÄ The portable package contains:"
          echo "   ‚úÖ ComputerAlgebraSystem.exe"
          echo "   ‚úÖ All required DLL libraries"
          echo "   ‚úÖ Qt plugins (platforms, imageformats, etc.)"
          echo "   üìù Ready to run on any Windows computer!"