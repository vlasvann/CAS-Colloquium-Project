name: Build Computer Algebra System

on:
  push:
    branches: [BabinTest, main]
  pull_request:
    branches: [BabinTest, main]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt and dependencies
      run: |
        echo "üîß Installing dependencies..."
        sudo apt-get update
        sudo apt-get install -y build-essential
        sudo apt-get install -y qt6-base-dev qt6-tools-dev qt6-tools-dev-tools
        sudo apt-get install -y g++ make

    - name: Build project
      run: |
        echo "üèóÔ∏è Building project..."
        qmake6 ComputerAlgebraSystem.pro || qmake ComputerAlgebraSystem.pro
        make -j4
        echo "‚úÖ Build completed"

    - name: Verify binary
      run: |
        if [ -f "build/ComputerAlgebraSystem" ]; then
          echo "‚úÖ Binary found in build folder"
          cp build/ComputerAlgebraSystem .
        else
          echo "‚ùå Binary not found"
          exit 1
        fi
        
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: ComputerAlgebraSystem-Linux
        path: ComputerAlgebraSystem
        retention-days: 30

  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.9.3'
        host: windows
        target: desktop
        arch: win64_msvc2022_64  # ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ–º MSVC –≤–º–µ—Å—Ç–æ MinGW

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Build project
      shell: cmd
      run: |
        echo üèóÔ∏è Building with MSVC...
        qmake -version
        qmake ComputerAlgebraSystem.pro -spec win32-msvc "CONFIG+=release"
        nmake
        echo ‚úÖ Build completed

    - name: Verify binary
      run: |
        echo "üîç Looking for Windows binary..."
        if (Test-Path "release\ComputerAlgebraSystem.exe") {
          echo "‚úÖ Binary found in release folder"
          copy release\ComputerAlgebraSystem.exe .
        } else {
          echo "‚ùå Binary not found in release/"
          Get-ChildItem -Recurse -Include *.exe
          exit 1
        }

    - name: Deploy dependencies
      run: |
        echo "üì¶ Deploying Windows dependencies..."
        windeployqt --release ComputerAlgebraSystem.exe
        echo "‚úÖ Dependencies deployed"

    - name: Create Windows portable package
      run: |
        echo "üì¶ Creating Windows portable package..."
        mkdir PortableApp
        copy ComputerAlgebraSystem.exe PortableApp\
        copy *.dll PortableApp\ 2>$null || echo "No DLLs"
        if (Test-Path "platforms") { copy platforms PortableApp\ -Recurse }
        if (Test-Path "imageformats") { copy imageformats PortableApp\ -Recurse }
        
        Compress-Archive -Path PortableApp\* -DestinationPath ComputerAlgebraSystem-Windows-Portable.zip -Force
        echo "‚úÖ Portable package created"

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ComputerAlgebraSystem-Windows-Portable.zip
        path: ComputerAlgebraSystem-Windows-Portable.zip
        retention-days: 30

    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: ComputerAlgebraSystem-Windows.exe
        path: ComputerAlgebraSystem.exe
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.9.3'
        host: mac
        target: desktop
        arch: clang_64

    - name: Build project
      run: |
        echo "üèóÔ∏è Building on macOS..."
        qmake -version
        qmake ComputerAlgebraSystem.pro -config release
        make -j4
        echo "‚úÖ Build completed"

    - name: Verify binary
      run: |
        echo "üîç Looking for macOS binary..."
        if [ -d "ComputerAlgebraSystem.app" ]; then
          echo "‚úÖ macOS app bundle found"
        elif [ -f "ComputerAlgebraSystem" ]; then
          echo "‚úÖ Binary found"
        else
          echo "‚ùå Binary not found"
          find . -name "ComputerAlgebraSystem*" -type f -o -type d
          exit 1
        fi

    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: ComputerAlgebraSystem-macOS
        path: ComputerAlgebraSystem.app
        if-no-files-found: ignore
        retention-days: 30