name: Build Computer Algebra System

on:
  push:
    branches: [BabinTest, main]
  pull_request:
    branches: [BabinTest, main]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt and dependencies
      run: |
        echo "üîß Installing dependencies..."
        sudo apt-get update
        sudo apt-get install -y build-essential
        sudo apt-get install -y qt6-base-dev qt6-tools-dev qt6-tools-dev-tools
        sudo apt-get install -y g++ make

    - name: Build project
      run: |
        echo "üèóÔ∏è Building project..."
        qmake6 ComputerAlgebraSystem.pro || qmake ComputerAlgebraSystem.pro
        make -j4
        echo "‚úÖ Build completed"

    - name: Verify binary
      run: |
        if [ -f "build/ComputerAlgebraSystem" ]; then
          echo "‚úÖ Binary found in build folder"
          cp build/ComputerAlgebraSystem .
        else
          echo "‚ùå Binary not found"
          exit 1
        fi
        
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: ComputerAlgebraSystem-Linux
        path: ComputerAlgebraSystem
        retention-days: 30

  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt with MinGW
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.9.3'
        host: windows
        target: desktop
        arch: win64_mingw

    - name: Build with MinGW
      run: |
        echo "üèóÔ∏è Building with MinGW..."
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ü–†–ê–í–ò–õ–¨–ù–´–ô –ø—É—Ç—å –∏–∑ –ª–æ–≥–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
        & "D:\a\CAS-Colloquium-Project\Qt\6.9.3\mingw_64\bin\qmake.exe" ComputerAlgebraSystem.pro
        & "D:\a\CAS-Colloquium-Project\Qt\6.9.3\mingw_64\bin\mingw32-make.exe"
        
        echo "‚úÖ Build completed"

    - name: Verify binary
      run: |
        if (Test-Path "release\ComputerAlgebraSystem.exe") {
          copy release\ComputerAlgebraSystem.exe .
          echo "‚úÖ Binary ready"
        } else {
          echo "‚ùå Binary not found in release/"
          # –ò—â–µ–º –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö
          if (Test-Path "build\ComputerAlgebraSystem.exe") {
            copy build\ComputerAlgebraSystem.exe .
            echo "‚úÖ Binary found in build/"
          } else {
            Get-ChildItem -Recurse -Include *.exe
            exit 1
          }
        }

    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: ComputerAlgebraSystem-Windows.exe
        path: ComputerAlgebraSystem.exe
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.9.3'
        host: mac
        target: desktop
        arch: clang_64

    - name: Build project
      run: |
        echo "üèóÔ∏è Building on macOS..."
        qmake -version
        qmake ComputerAlgebraSystem.pro -config release
        make -j4
        echo "‚úÖ Build completed"

    - name: Verify binary
      run: |
        echo "üîç Looking for macOS binary..."
        if [ -d "ComputerAlgebraSystem.app" ]; then
          echo "‚úÖ macOS app bundle found"
        elif [ -f "ComputerAlgebraSystem" ]; then
          echo "‚úÖ Binary found"
        else
          echo "‚ùå Binary not found"
          find . -name "ComputerAlgebraSystem*" -type f -o -type d
          exit 1
        fi

    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: ComputerAlgebraSystem-macOS
        path: ComputerAlgebraSystem.app
        if-no-files-found: ignore
        retention-days: 30