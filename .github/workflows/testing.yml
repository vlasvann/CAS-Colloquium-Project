name: ðŸ”§ Build Windows Installer
on:
  pull_request:
  push:
    branches: [BabinTest, main]
  workflow_dispatch:

jobs:
  build-windows-installer:
    runs-on: windows-latest
    steps:
      - name: Install MinGW (ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ‚Ð¾Ñ€ Ð´Ð»Ñ Windows)
        uses: egor-tensin/setup-mingw@v1
        with:
          platform: x64
          version: 11.2.0

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.9.3'
          host: windows
          target: desktop
          arch: win64_mingw
          tools: tools_ifw
          add-tools-to-path: true

      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          echo "ðŸ”§ Setting up environment..."
          echo "PATH=$PATH"
          echo "MINGW_PATH=C:\msys64\mingw64\bin"
          g++ --version
          which g++

      - name: Build application (Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ)
        run: |
          echo "ðŸ—ï¸ Building application..."
          qmake -version
          
          # Ð¯Ð²Ð½Ð¾ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿ÑƒÑ‚ÑŒ Ðº ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ‚Ð¾Ñ€Ñƒ
          qmake ComputerAlgebraSystem.pro -spec win32-g++ "CONFIG+=release" "QMAKE_CXX=g++"
          
          echo "ðŸ”¨ Running make..."
          make -j4
          
          echo "âœ… Build completed"

      - name: Verify binary exists
        run: |
          if (Test-Path "release\ComputerAlgebraSystem.exe") {
            echo "âœ… Binary found in release folder"
            copy release\ComputerAlgebraSystem.exe .\
          } elseif (Test-Path "ComputerAlgebraSystem.exe") {
            echo "âœ… Binary found in root folder"
          } else {
            echo "âŒ Binary not found"
            Get-ChildItem -Recurse -Include *.exe
            exit 1
          }

      - name: Deploy dependencies
        run: |
          windeployqt --release ComputerAlgebraSystem.exe

      - name: Create installer package
        run: |
          mkdir installer_package
          copy ComputerAlgebraSystem.exe installer_package/
          copy *.dll installer_package/ 2>$null || echo "No DLLs to copy"
          if (Test-Path "platforms") { copy platforms installer_package/ -Recurse }
          if (Test-Path "imageformats") { copy imageformats installer_package/ -Recurse }
          if (Test-Path "styles") { copy styles installer_package/ -Recurse }
          
          Compress-Archive -Path installer_package/* -DestinationPath ComputerAlgebraSystem-Windows-Installer.zip -Force
          echo "ðŸ“¦ Installer package created"

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: ComputerAlgebraSystem-Windows-Installer.zip
          path: ComputerAlgebraSystem-Windows-Installer.zip
          retention-days: 30