name: Build and Release Qt App - Multiplatform

on:
  push:
    branches:
      - BabinTest
  release:
    types: [created]

jobs:
  build-matrix:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            qt_host: windows
            qt_version: '6.9.3'
            qt_arch: win64_msvc2022_64  # ← ИСПРАВЛЕННАЯ АРХИТЕКТУРА
            artifact: ComputerAlgebraSystem-windows-x64.zip
            binary_path: ComputerAlgebraSystem.exe
            deploy_cmd: windeployqt --release ComputerAlgebraSystem.exe
          - os: ubuntu-latest
            qt_host: linux
            qt_version: '6.9.3'
            qt_arch: gcc_64  # ← АРХИТЕКТУРА ДЛЯ LINUX
            artifact: ComputerAlgebraSystem-linux-x64.tar.gz
            binary_path: ComputerAlgebraSystem
            deploy_cmd: |
              mkdir -p deployment
              cp ComputerAlgebraSystem deployment/
          - os: macos-latest
            qt_host: mac
            qt_version: '6.9.3'
            qt_arch: clang_64  # ← АРХИТЕКТУРА ДЛЯ MAC
            artifact: ComputerAlgebraSystem-macos-x64.zip
            binary_path: ComputerAlgebraSystem.app
            deploy_cmd: |
              macdeployqt ComputerAlgebraSystem.app -dmg
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ matrix.qt_version }}
          host: ${{ matrix.qt_host }}
          target: desktop
          arch: ${{ matrix.qt_arch }}  # ← ДОБАВЛЕН ПАРАМЕТР АРХИТЕКТУРЫ
          install-deps: true

      - name: Build with qmake
        run: |
          qmake -version
          qmake ComputerAlgebraSystem.pro -config release
          make -j4

      - name: Verify binary exists
        run: |
          if [ ! -f "${{ matrix.binary_path }}" ]; then
            echo "Binary not found at ${{ matrix.binary_path }}"
            echo "Available files:"
            find . -name "*.exe" -o -name "*.app" -o -type f -executable
            exit 1
          fi

      - name: Deploy dependencies
        run: ${{ matrix.deploy_cmd }}

      - name: Package application
        shell: bash
        run: |
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            zip -r ${{ matrix.artifact }} *.exe *.dll platforms/ imageformats/
          elif [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
            tar -czf ${{ matrix.artifact }} deployment/
          else
            zip -r ${{ matrix.artifact }} ComputerAlgebraSystem.app
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}
          retention-days: 7