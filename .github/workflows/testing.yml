name: Build Computer Algebra System

on:
  push:
    branches: [BabinTest, main]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSVC Environment
      run: |
        echo "üîß Setting up MSVC..."
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π VS –≥–¥–µ —É–∂–µ –≤—Å—ë –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
        "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        cl.exe
        nmake.exe /?

    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.9.3'
        host: windows
        target: desktop
        arch: win64_msvc2022_64

    - name: Build with MSVC
      shell: cmd
      run: |
        echo üèóÔ∏è Building with MSVC...
        qmake.exe -version
        qmake.exe ComputerAlgebraSystem.pro -spec win32-msvc "CONFIG+=release"
        nmake.exe
        echo ‚úÖ Build completed

    - name: Verify binary
      run: |
        if (Test-Path "release\ComputerAlgebraSystem.exe") {
          echo "‚úÖ Binary found"
          copy release\ComputerAlgebraSystem.exe .
        } else {
          echo "‚ùå Binary not found in release/"
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –º–µ—Å—Ç–∞
          if (Test-Path "ComputerAlgebraSystem.exe") {
            echo "‚úÖ Binary found in root"
          } else {
            Get-ChildItem -Recurse -Include *.exe
            exit 1
          }
        }

    - name: Deploy dependencies
      run: |
        windeployqt.exe --release ComputerAlgebraSystem.exe
        echo "üì¶ Dependencies deployed"

    - name: Create Windows Installer
      run: |
        # –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º
        mkdir ComputerAlgebraSystem_Windows
        copy ComputerAlgebraSystem.exe ComputerAlgebraSystem_Windows\
        copy *.dll ComputerAlgebraSystem_Windows\ 2>$null || echo "No DLLs"
        if (Test-Path "platforms") { copy platforms ComputerAlgebraSystem_Windows\ -Recurse }
        if (Test-Path "imageformats") { copy imageformats ComputerAlgebraSystem_Windows\ -Recurse }
        
        # –°–æ–∑–¥–∞—ë–º ZIP –∞—Ä—Ö–∏–≤
        Compress-Archive -Path ComputerAlgebraSystem_Windows\* -DestinationPath ComputerAlgebraSystem-Windows.zip -Force
        echo "üéÅ Windows package created"

    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: ComputerAlgebraSystem-Windows.zip
        path: ComputerAlgebraSystem-Windows.zip
        retention-days: 30

    - name: Upload Executable only
      uses: actions/upload-artifact@v4
      with:
        name: ComputerAlgebraSystem.exe
        path: ComputerAlgebraSystem.exe
        retention-days: 30