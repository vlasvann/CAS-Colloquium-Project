name: ðŸ”§ Build Windows Application
on:
  pull_request:
  push:
    branches: [BabinTest, main]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.9.3'
          host: windows
          target: desktop
          arch: win64_mingw
          cache: true

      - name: Install CMake
        uses: lukka/get-cmake@latest

      - name: Build with CMake (Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð±)
        run: |
          echo "ðŸ—ï¸ Building with CMake..."
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸
          mkdir build
          cd build
          
          echo "ðŸ”§ Configuring with CMake..."
          cmake .. -G "MinGW Makefiles" -DCMAKE_PREFIX_PATH="C:/Qt/6.9.3/mingw_64/lib/cmake" -DCMAKE_BUILD_TYPE=Release
          
          echo "ðŸ”¨ Building application..."
          cmake --build . --config Release
          
          echo "âœ… Build completed"

      - name: Verify binary
        run: |
          echo "ðŸ” Looking for binary..."
          if (Test-Path "build\ComputerAlgebraSystem.exe") {
            echo "âœ… Binary found in build folder"
            copy build\ComputerAlgebraSystem.exe .\
          } elseif (Test-Path "build\Release\ComputerAlgebraSystem.exe") {
            echo "âœ… Binary found in build/Release folder"
            copy build\Release\ComputerAlgebraSystem.exe .\
          } else {
            echo "âŒ Binary not found"
            Get-ChildItem -Recurse -Include *.exe
            exit 1
          }

      - name: Deploy dependencies
        run: |
          echo "ðŸ“¦ Deploying dependencies..."
          windeployqt.exe --release ComputerAlgebraSystem.exe
          echo "âœ… Dependencies deployed"

      - name: Create portable package
        run: |
          echo "ðŸ“¦ Creating portable package..."
          mkdir PortableApp
          copy ComputerAlgebraSystem.exe PortableApp\
          copy *.dll PortableApp\ 2>$null || echo "No DLLs"
          if (Test-Path "platforms") { copy platforms PortableApp\ -Recurse }
          if (Test-Path "imageformats") { copy imageformats PortableApp\ -Recurse }
          
          Compress-Archive -Path PortableApp\* -DestinationPath ComputerAlgebraSystem-Windows.zip -Force
          echo "âœ… Package created"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ComputerAlgebraSystem-Windows.zip
          path: ComputerAlgebraSystem-Windows.zip
          retention-days: 30