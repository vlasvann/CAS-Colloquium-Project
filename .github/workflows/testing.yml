name: üîß Build Windows Installer
on:
  pull_request:
  push:
    branches: [BabinTest, main]
  workflow_dispatch:

jobs:
  build-windows-installer:
    runs-on: windows-latest
    steps:
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.9.3'
          host: windows
          target: desktop
          arch: win64_mingw
          tools: tools_ifw  # ‚Üê Qt Installer Framework
          add-tools-to-path: true

      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Build application
        run: |
          qmake -version
          qmake ComputerAlgebraSystem.pro -spec win32-g++ "CONFIG+=release"
          make -j4

      - name: Verify binary exists
        run: |
          if (Test-Path "ComputerAlgebraSystem.exe") {
            echo "‚úÖ Binary found: ComputerAlgebraSystem.exe"
            dir ComputerAlgebraSystem.exe
          } else {
            echo "‚ùå Binary not found"
            Get-ChildItem -Recurse -Include *.exe
            exit 1
          }

      - name: Deploy dependencies
        run: |
          windeployqt --release ComputerAlgebraSystem.exe

      - name: Create installer package
        run: |
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞
          mkdir installer_package
          
          # –ö–æ–ø–∏—Ä—É–µ–º –±–∏–Ω–∞—Ä–Ω–∏–∫ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          copy ComputerAlgebraSystem.exe installer_package/
          copy *.dll installer_package/ 2>$null || echo "No DLLs to copy"
          if (Test-Path "platforms") { copy platforms installer_package/ -Recurse }
          if (Test-Path "imageformats") { copy imageformats installer_package/ -Recurse }
          if (Test-Path "styles") { copy styles installer_package/ -Recurse }
          
          # –°–æ–∑–¥–∞–µ–º ZIP —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫
          Compress-Archive -Path installer_package/* -DestinationPath ComputerAlgebraSystem-Windows-Installer.zip -Force
          
          echo "üì¶ Installer package created"

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: ComputerAlgebraSystem-Windows-Installer.zip
          path: ComputerAlgebraSystem-Windows-Installer.zip
          retention-days: 30

      - name: Show build summary
        run: |
          echo "üéä Windows installer build completed!"
          echo "Installer: ComputerAlgebraSystem-Windows-Installer.zip"
          echo "Includes: Application + All Dependencies"