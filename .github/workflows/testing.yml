name: ðŸ”§ Build Windows Application
on:
  pull_request:
  push:
    branches: [BabinTest, main]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Install Qt with MinGW (ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ)
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.9.3'
          host: windows
          target: desktop
          arch: win64_mingw
          cache: true

      - name: Build application (Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð±)
        run: |
          echo "ðŸ”§ Setting up environment..."
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ MinGW Ð² PATH
          $mingwPath = "C:\Qt\6.9.3\mingw_64\bin"
          $env:PATH = "$mingwPath;" + $env:PATH
          
          echo "ðŸ—ï¸ Building application..."
          qmake -version
          g++ --version
          
          # ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ ÑÐ±Ð¾Ñ€ÐºÐ°
          qmake ComputerAlgebraSystem.pro
          mingw32-make -j4
          
          echo "âœ… Build completed"

      - name: Verify binary
        run: |
          if (Test-Path "release\ComputerAlgebraSystem.exe") {
            echo "âœ… Binary found in release folder"
            copy release\ComputerAlgebraSystem.exe .\
          } elseif (Test-Path "ComputerAlgebraSystem.exe") {
            echo "âœ… Binary found in root folder"
          } else {
            echo "âŒ Binary not found, searching..."
            Get-ChildItem -Recurse -Include *.exe
            exit 1
          }

      - name: Deploy dependencies
        run: |
          windeployqt --release ComputerAlgebraSystem.exe

      - name: Create portable package
        run: |
          mkdir PortableApp
          copy ComputerAlgebraSystem.exe PortableApp/
          copy *.dll PortableApp/ 2>$null || echo "No DLLs"
          if (Test-Path "platforms") { copy platforms PortableApp/ -Recurse }
          if (Test-Path "imageformats") { copy imageformats PortableApp/ -Recurse }
          
          Compress-Archive -Path PortableApp/* -DestinationPath ComputerAlgebraSystem-Windows-Portable.zip -Force
          echo "ðŸ“¦ Portable package created"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ComputerAlgebraSystem-Windows-Portable.zip
          path: ComputerAlgebraSystem-Windows-Portable.zip
          retention-days: 30